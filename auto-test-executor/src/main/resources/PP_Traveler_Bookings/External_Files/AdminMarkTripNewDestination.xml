<?xml version="1.0" encoding="UTF-8"?>
<con:soapui-project id="e7833335-d436-48c5-8c74-32d84e89a8b9" activeEnvironment="Default" name="Admin Mark Trip New Destination" resourceRoot="" soapui-version="5.3.0" abortOnError="false" runType="SEQUENTIAL" xmlns:con="http://eviware.com/soapui/config"><con:settings/><con:interface xsi:type="con:RestService" id="0396dcf7-496a-4ec7-90ae-8c78c5c0f848" wadlVersion="http://wadl.dev.java.net/2009/02" name="AdminMarkTripNewDestination" type="rest" definitionUrl="api/v3/requested_trips/{request_id}/mark_new_destination" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings/><con:definitionCache type="TEXT"/><con:endpoints/><con:resource name="mark_new_destination" path="/api/v3/requested_trips/{request_id}/mark_new_destination" id="407d4922-f120-47b3-9f7a-fef1dce13c53"><con:settings/><con:parameters><con:parameter><con:name>request_id</con:name><con:value/><con:style>TEMPLATE</con:style><con:default/><con:description xsi:nil="true"/></con:parameter><con:parameter><con:name>security_auth_token</con:name><con:value/><con:style>QUERY</con:style><con:default/><con:description xsi:nil="true"/></con:parameter></con:parameters><con:method name="Method 1" id="213965a6-3675-4c3a-9f79-3ed674ebfa40" method="POST"><con:settings/><con:parameters/><con:request name="Request 1" id="9404fdb5-3567-4036-bf84-8f5ae6291a54" mediaType="application/json" postQueryString="false"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment xmlns:con="http://eviware.com/soapui/config">
  &lt;con:entry key="TT-Mobile" value=""/>
  &lt;con:entry key="Content-Type" value="application/json; charset=utf-8"/>
  &lt;con:entry key="Accept" value="application/json"/>
&lt;/xml-fragment></con:setting></con:settings><con:endpoint>http://${#Project#traveler_apiendpoint}</con:endpoint><con:request>{"status": "New Destination"}</con:request><con:originalUri>http://null//</con:originalUri><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:parameterOrder><con:entry>request_id</con:entry><con:entry>security_auth_token</con:entry></con:parameterOrder></con:request></con:method></con:resource></con:interface><con:interface xsi:type="con:RestService" id="f43d304b-9e1c-4500-9552-939467deee52" wadlVersion="http://wadl.dev.java.net/2009/02" name="SIGININ" type="rest" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings/><con:definitionCache type="TEXT" rootPart=""/><con:endpoints/><con:resource name="sign_in" path="/users/sign_in" id="f44bac0d-a6b7-48c5-be33-b9ddf0148e8b"><con:settings/><con:parameters/><con:method name="Method 1" id="7c2f2b0b-3361-4c99-977e-d1f557bc5a4a" method="POST"><con:settings/><con:parameters/><con:representation type="FAULT"><con:mediaType>application/json; charset=utf-8</con:mediaType><con:status>401</con:status><con:params/><con:element xmlns:sign="https://bookings-qa1.ttdev.in/users/sign_in">sign:Fault</con:element></con:representation><con:representation type="REQUEST"><con:mediaType>application/json</con:mediaType><con:params/></con:representation><con:representation type="RESPONSE"><con:mediaType>text/html; charset=utf-8</con:mediaType><con:status>200</con:status><con:params/><con:element>html</con:element></con:representation><con:representation type="RESPONSE"><con:mediaType xsi:nil="true"/><con:status>0</con:status><con:params/><con:element>data</con:element></con:representation><con:request name="Request 1" id="cdeb86ec-91af-43d2-b173-5351d17bf9a2" mediaType="application/json" postQueryString="false"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers"><![CDATA[<xml-fragment xmlns:con="http://eviware.com/soapui/config">
  <con:entry key="TT-Mobile-Post" value="kp!@#$%^&amp;*9"/>
  <con:entry key="TT-Mobile" value=""/>
  <con:entry key="Accept" value="application/json"/>
  <con:entry key="Content-Type" value="application/json; charset=utf-8;"/>
</xml-fragment>]]></con:setting></con:settings><con:endpoint>https://${#Project#traveler_apiendpoint}</con:endpoint><con:request>{"login_type":"json","user":{"email":"kanupriya@traveltriangle.com","password":"kp!@#$%^&amp;*9"}}</con:request><con:credentials><con:username>ttuser</con:username><con:password>ttuser</con:password><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>Global HTTP Settings</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/></con:request></con:method></con:resource></con:interface><con:testSuite id="42e6634c-046e-4a8c-bb07-cb5f6f0771af" name="AdminMarkTripAsNewDestination"><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase id="81f92d4a-a856-41c9-9783-69a3793a85a3" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="Admin_mark_trip_as_new_destination" searchProperties="true"><con:settings/><con:testStep type="calltestcase" name="Given user gets the hash key" id="dba45f93-53e7-4aa8-b596-63058a6c0708"><con:settings/><con:config xsi:type="con:RunTestCaseStep" copyHttpSession="true" copyLoadTestProperties="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:targetTestCase>bb6a30fb-7c20-4747-b542-d72dfb4fee3c</con:targetTestCase><con:properties><con:property><con:name>request_url</con:name><con:value>http://${#TestCase#endpoint}/users/sign_in</con:value></con:property><con:property><con:name>user_email</con:name><con:value>${TestCase#ops_email}</con:value></con:property><con:property><con:name>request_type</con:name><con:value>post</con:value></con:property><con:property><con:name>hash_key</con:name><con:value>DFq9JpnEk9B3IzLDRQjgQp8ZK8WBQmACxWOt8w1FkM8=</con:value></con:property></con:properties><con:returnProperties><con:entry>hash_key</con:entry></con:returnProperties><con:runMode>SINGLETON_AND_WAIT</con:runMode></con:config></con:testStep><con:testStep type="restrequest" name="Admin login with valid credential" id="05bd1036-d0fb-4cee-b2ae-b8d842540faa"><con:settings/><con:config service="SIGININ" resourcePath="/users/sign_in" methodName="Method 1" xsi:type="con:RestRequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:restRequest name="Admin login with valid credential" id="cdeb86ec-91af-43d2-b173-5351d17bf9a2" mediaType="application/json" postQueryString="false"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment xmlns:con="http://eviware.com/soapui/config">
  &lt;con:entry key="TT-Mobile" value="${Given user gets the hash key#hash_key}"/>
  &lt;con:entry key="Content-Type" value="application/json; charset=UTF-8"/>
  &lt;con:entry key="Accept" value="application/json"/>
&lt;/xml-fragment></con:setting></con:settings><con:endpoint>http://${#TestCase#endpoint}</con:endpoint><con:request>{"login_type":"json","user":{"email":"${#TestCase#ops_email}","password":"${#TestCase#ops_password}"}}</con:request><con:originalUri>https://bookings-qa1.ttdev.in/users/sign_in</con:originalUri><con:assertion type="Valid HTTP Status Codes" id="525a9da4-482d-418a-98ca-a59072ca34d1" name="Valid HTTP Status Codes"><con:configuration><codes>200</codes></con:configuration></con:assertion><con:assertion type="Simple Contains" id="51149cb3-4f92-4ee9-b620-896c67d62353" name="EmailExistInResponse"><con:configuration><token>${#TestCase#user_email}</token><ignoreCase>true</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="c7d63336-6d4f-4c29-aa8c-7599f886964b" name="Get the response Cookies"><con:configuration><scriptText>for(String cookie in messageExchange.getResponseHeaders()["Set-Cookie"]){
	if(cookie.contains("_trips3m_session")){
		messageExchange.modelItem.testCase.setPropertyValue("Cookie",cookie);
	}
}</scriptText></con:configuration></con:assertion><con:credentials><con:username>ttuser</con:username><con:password>ttuser</con:password><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>Global HTTP Settings</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/></con:restRequest></con:config></con:testStep><con:testStep type="calltestcase" name="Get the hash key for marking trip as new destination" id="ea3bacdc-d119-448f-8ad8-29392651a841"><con:settings/><con:config xsi:type="con:RunTestCaseStep" copyHttpSession="true" copyLoadTestProperties="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:targetTestCase>bb6a30fb-7c20-4747-b542-d72dfb4fee3c</con:targetTestCase><con:properties><con:property><con:name>request_url</con:name><con:value>http://${#TestCase#endpoint}/api/v3/requested_trips/{request_id}/mark_new_destination}</con:value></con:property><con:property><con:name>user_email</con:name><con:value>${#TestCase#ops_email}</con:value></con:property><con:property><con:name>request_type</con:name><con:value>post</con:value></con:property><con:property><con:name>hash_key</con:name><con:value>UpZ/2/flvoKezmFiz9oV2JxvYOE3Zzj4dZX8xeIGEwQ=</con:value></con:property></con:properties><con:returnProperties><con:entry>hash_key</con:entry></con:returnProperties><con:runMode>SINGLETON_AND_WAIT</con:runMode></con:config></con:testStep><con:testStep type="restrequest" name="Ops mark the trip as new destination" id="724a1919-336a-485b-937a-db83e326ff84"><con:settings/><con:config service="AdminMarkTripNewDestination" resourcePath="/api/v3/requested_trips/{request_id}/mark_new_destination" methodName="Method 1" xsi:type="con:RestRequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:restRequest name="Ops mark the trip as new destination" id="9404fdb5-3567-4036-bf84-8f5ae6291a54" mediaType="application/json" postQueryString="false"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers"><![CDATA[<xml-fragment xmlns:con="http://eviware.com/soapui/config">
  <con:entry key="Cookie" value="${#TestCase#Cookie}"/>
  <con:entry key="TT-Mobile" value="${Get the hash key for marking the trip as new destination#hash_key}"/>
  <con:entry key="Content-Type" value="application/json; charset=utf-8;"/>
  <con:entry key="Accept" value="application/json;"/>
</xml-fragment>]]></con:setting></con:settings><con:encoding/><con:endpoint>http://${#TestCase#endpoint}</con:endpoint><con:request>{"status": "New Destination"}</con:request><con:originalUri>http://null//</con:originalUri><con:assertion type="Valid HTTP Status Codes" id="dab0b2ed-399d-49ac-8cb1-eae390af383c" name="Valid HTTP Status Codes"><con:configuration><codes>200</codes></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="8992051f-cf5a-49e6-acdf-56a5259ff1b9" name="Script Assertion"><con:configuration><scriptText>import groovy.json.JsonSlurper;

String response = messageExchange.getResponseContent();
def json_response_holder = new JsonSlurper().parseText(response);

String success = json_response_holder.success;

messageExchange.modelItem.testCase.setPropertyValue("success", success);</scriptText></con:configuration></con:assertion><con:credentials><con:username>ttuser</con:username><con:password>ttuser</con:password><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>Global HTTP Settings</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters>
  <con:entry key="request_id" value="${#TestCase#request_id}"/>
  <con:entry key="security_auth_token" value="ekxnfvoxefmpelbvzuerofqmtcffxxcuwengpdrvwwgrbajkrk"/>
</con:parameters><con:parameterOrder><con:entry>request_id</con:entry><con:entry>security_auth_token</con:entry></con:parameterOrder></con:restRequest></con:config></con:testStep><con:properties><con:property><con:name>endpoint</con:name><con:value>bookings-qa5.ttdev.in</con:value></con:property><con:property><con:name>ops_email</con:name><con:value>kanupriya@traveltriangle.com</con:value></con:property><con:property><con:name>ops_password</con:name><con:value>kp!@#$%^&amp;*9</con:value></con:property><con:property><con:name>request_id</con:name><con:value>1755585</con:value></con:property><con:property><con:name>Cookie</con:name><con:value>_trips3m_session=BAh7CkkiD3Nlc3Npb25faWQGOgZFVEkiJWVjYmY3Yzk2Mzk1NTkzNTJiNTIxZGViMTU5MzM4ZmMwBjsAVEkiGXdhcmRlbi51c2VyLnVzZXIua2V5BjsAVFsHWwZpA91qA0kiIiQyYSQxMCRDS3JFQlFQdXVpTzlUdEZYNFpGeGplBjsAVEkiDHJlZmVyZXIGOwBUSSIABjsAVEkiDm5leHRfcGF0aAY7AEZJIhYvYWRtaW5zL2Rhc2hib2FyZAY7AEZJIhBfY3NyZl90b2tlbgY7AEZJIjFaTGx1V0hpem1pK0lpYU9lK2dYVFZBSHVjKy9Ya2s0aHFsbzBTYThnTTlZPQY7AEY%3D--e7d2ce6a4a18bb9872ee68b73d2beabbab1c6749; path=/; HttpOnly</con:value></con:property><con:property><con:name>success</con:name><con:value>true</con:value></con:property></con:properties></con:testCase><con:properties/></con:testSuite><con:testSuite id="ab30870b-c24b-45f6-a33f-7bb0da622184" name="ReusableTests" disabled="true"><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase id="bb6a30fb-7c20-4747-b542-d72dfb4fee3c" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="CreateToken" searchProperties="true"><con:settings/><con:testStep type="groovy" name="Groovy Script" id="722939e9-d69e-4633-b6eb-6ed6840f5c9a"><con:settings/><con:config><script>import java.security.MessageDigest;
import org.codehaus.groovy.runtime.EncodingGroovyMethods;


String requestUrl = context.expand('${#TestCase#request_url}');
String userEmail = context.expand('${#TestCase#user_email}');
String requestType = context.expand('${#TestCase#request_type}');
log.info requestUrl;
String digest;

if( requestType == "get" ){
  	digest = requestUrl; 
} else {
digest = userEmail + requestType;
}

digest = getUserDigest(digest); //this is final digest

log.info digest;
testRunner.testCase.setPropertyValue("hash_key",digest);

String getUserDigest(String digest) {
   String TT_S_KEY = "DAFAC0A55F50A75558B778035E3C9A8BDF03AF1E4C2124D2CD5DD42092EFD32E";
   try {
       digest = TT_S_KEY + digest;
       MessageDigest msgDigest = MessageDigest.getInstance("SHA-256");
       msgDigest.update(digest.getBytes());
       EncodingGroovyMethods encodeObj = new EncodingGroovyMethods();
       //digest = new String(Base64.encode(msgDigest.digest(), Base64.DEFAULT));
       digest = encodeObj.encodeBase64(msgDigest.digest()).toString();
       if (digest.length() > 164) {
           digest = digest.substring(0, 163);
       }
       return digest;
   } catch (Exception e) {
       log.info e.getMessage();
   }
   return null;
}
</script></con:config></con:testStep><con:properties><con:property><con:name>request_url</con:name><con:value>http://bookings-qa5.ttdev.in/api/v3/requested_trips/{request_id}/mark_new_destination}</con:value></con:property><con:property><con:name>user_email</con:name><con:value>kanupriya@traveltriangle.com</con:value></con:property><con:property><con:name>request_type</con:name><con:value>post</con:value></con:property><con:property><con:name>hash_key</con:name><con:value>UpZ/2/flvoKezmFiz9oV2JxvYOE3Zzj4dZX8xeIGEwQ=</con:value></con:property></con:properties><con:reportParameters/></con:testCase><con:properties/><con:reportParameters/></con:testSuite><con:properties/><con:wssContainer/><con:oAuth2ProfileContainer/><con:oAuth1ProfileContainer/><con:sensitiveInformation/></con:soapui-project>